@model ConsultingGroup.ViewModels.StudioIndexViewModel
@{
    ViewData["Title"] = "Gestione Studios";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <!-- Header con statistiche -->
    <div class="card shadow mb-4">
        <div class="card-header bg-gradient-primary text-white">
            <div class="d-flex align-items-center justify-content-between">
                <h3 class="mb-0">
                    <i class="fas fa-building me-2"></i>
                    Gestione Studios
                </h3>
                <div class="text-end">
                    <div class="row g-3">
                        <div class="col-auto">
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check-circle me-1"></i>
                                @Model.TotaleAttivi Attivi
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-danger fs-6">
                                <i class="fas fa-times-circle me-1"></i>
                                @Model.TotaleCessati Cessati
                            </span>
                        </div>
                        @if (Model.TotaleRiattivati > 0)
                        {
                            <div class="col-auto">
                                <span class="badge bg-warning fs-6">
                                    <i class="fas fa-sync me-1"></i>
                                    @Model.TotaleRiattivati Riattivati
                                </span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtri e Azioni -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="get" asp-action="Index" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-filter me-1"></i>Filtra per Stato
                    </label>
                    <select name="filtroStato" class="form-select" asp-for="FiltroStato">
                        <option value="tutti">Tutti gli Studios</option>
                        <option value="attivi">Solo Attivi</option>
                        <option value="cessati">Solo Cessati</option>
                        <option value="riattivati">Solo Riattivati</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">
                        <i class="fas fa-search me-1"></i>Ricerca Studio
                    </label>
                    <input type="text" name="ricerca" class="form-control" placeholder="Nome studio..." asp-for="Ricerca" />
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Cerca
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Reset
                    </a>
                </div>
                <div class="col-md-2 text-end">
                    <a asp-action="Create" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Nuovo Studio
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabella Studios -->
    <div class="card shadow">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Elenco Studios (@Model.Studios.Count risultati)
            </h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Studios.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">
                                    <i class="fas fa-hashtag me-1"></i>ID
                                </th>
                                <th scope="col">
                                    <i class="fas fa-building me-1"></i>Nome Studio
                                </th>
                                <th scope="col">
                                    <i class="fas fa-traffic-light me-1"></i>Stato
                                </th>
                                <th scope="col">
                                    <i class="fas fa-calendar me-1"></i>Data Attivazione
                                </th>
                                <th scope="col">
                                    <i class="fas fa-clock me-1"></i>Ultima Modifica
                                </th>
                                <th scope="col" class="text-center">
                                    <i class="fas fa-cogs me-1"></i>Azioni
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var studio in Model.Studios)
                            {
                                <tr>
                                    <td class="align-middle">
                                        <strong class="text-primary">#@studio.Id</strong>
                                    </td>
                                    <td class="align-middle">
                                        <div>
                                            <strong>@studio.NomeStudio</strong>
                                            @if (studio.IsRiattivato)
                                            {
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="fas fa-sync me-1"></i>Anno @studio.RiattivatoperAnno
                                                </span>
                                            }
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <span class="badge bg-@studio.StatoClasse fs-6">
                                            <i class="fas @studio.StatoIcona me-1"></i>
                                            @studio.StatoCompleto
                                        </span>
                                    </td>
                                    <td class="align-middle">
                                        <small class="text-muted">
                                            @studio.DataAttivazione.ToString("dd/MM/yyyy")
                                        </small>
                                    </td>
                                    <td class="align-middle">
                                        <small class="text-muted">
                                            @studio.DataModifica.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                        @if (studio.DataCessazione.HasValue)
                                        {
                                            <br />
                                            <small class="text-danger">
                                                <i class="fas fa-stop-circle me-1"></i>
                                                Cessato: @studio.DataCessazione.Value.ToString("dd/MM/yyyy")
                                            </small>
                                        }
                                        @if (studio.DataRiattivazione.HasValue)
                                        {
                                            <br />
                                            <small class="text-warning">
                                                <i class="fas fa-sync me-1"></i>
                                                Riattivato: @studio.DataRiattivazione.Value.ToString("dd/MM/yyyy")
                                            </small>
                                        }
                                    </td>
                                    <td class="align-middle text-center">
                                        <div class="btn-group" role="group">
                                            <!-- Visualizza -->
                                            <a asp-action="Details" asp-route-id="@studio.Id" 
                                               class="btn btn-sm btn-outline-info" 
                                               title="Visualizza dettagli">
                                                <i class="fas fa-eye"></i>
                                            </a>

                                            <!-- Modifica -->
                                            <a asp-action="Edit" asp-route-id="@studio.Id" 
                                               class="btn btn-sm btn-outline-primary" 
                                               title="Modifica studio">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <!-- Toggle Stato -->
                                            <form method="post" asp-action="ToggleStatus" asp-route-id="@studio.Id" class="d-inline" 
                                                  onsubmit="return confirm('@(studio.Attivo ? "Confermi la disattivazione" : "Confermi l\'attivazione") di questo studio?')">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" 
                                                        class="btn btn-sm btn-outline-@(studio.Attivo ? "warning" : "success")"
                                                        title="@(studio.Attivo ? "Disattiva" : "Attiva") studio">
                                                    <i class="fas fa-@(studio.Attivo ? "pause" : "play")"></i>
                                                </button>
                                            </form>

                                            <!-- Riattiva (solo per cessati) -->
                                            @if (!studio.Attivo)
                                            {
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#riattivaModal@(studio.Id)"
                                                        title="Riattiva per anno fiscale">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            }

                                            <!-- Elimina -->
                                            <form method="post" asp-action="Delete" asp-route-id="@studio.Id" class="d-inline" 
                                                  onsubmit="return confirm('Sei sicuro di voler eliminare questo studio? Questa azione non può essere annullata.')">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" 
                                                        class="btn btn-sm btn-outline-danger"
                                                        title="Elimina studio">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-building fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Nessun studio trovato</h4>
                    <p class="text-muted">
                        @if (!string.IsNullOrWhiteSpace(Model.Ricerca) || Model.FiltroStato != "tutti")
                        {
                            <span>Prova a modificare i filtri di ricerca.</span>
                        }
                        else
                        {
                            <span>Inizia creando il tuo primo studio.</span>
                        }
                    </p>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Crea Primo Studio
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal per Riattivazione -->
@foreach (var studio in Model.Studios.Where(s => !s.Attivo))
{
    <div class="modal fade" id="riattivaModal@(studio.Id)" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sync me-2"></i>
                        Riattiva Studio
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" asp-action="Riattiva" asp-route-id="@studio.Id">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <p>Riattivare lo studio <strong>@studio.NomeStudio</strong> per un anno fiscale specifico?</p>
                        <div class="mb-3">
                            <label class="form-label">Anno Fiscale</label>
                            <select name="annoFiscale" class="form-select" required>
                                <option value="">Seleziona anno fiscale...</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-sync me-1"></i>Riattiva
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Auto-submit per filtri
        document.addEventListener('DOMContentLoaded', function() {
            const filtroStato = document.querySelector('select[name="filtroStato"]');
            if (filtroStato) {
                filtroStato.addEventListener('change', function() {
                    this.form.submit();
                });
            }
        });

        // Conferma eliminazione con dettagli
        function confermaEliminazione(nomeStudio) {
            return confirm(`Sei sicuro di voler eliminare lo studio "${nomeStudio}"?\n\nQuesta azione non può essere annullata e comporterà la perdita di tutti i dati associati.`);
        }
    </script>
}

<style>
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9rem;
}

.btn-group .btn {
    border-radius: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.btn-group .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
}
</style>
