@model IEnumerable<ConsultingGroup.Models.Attivita760>
@{
    ViewData["Title"] = "Mod. 760";
    var annoSelezionato = ViewBag.AnnoSelezionato as int? ?? DateTime.Now.Year;
    var annoFiscale = ViewBag.AnnoFiscale as ConsultingGroup.Models.AnnoFiscale;
}

<!-- Filtro Anno -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Anno di Riferimento
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="d-flex align-items-center gap-3">
                    <label for="annoSelezionato" class="form-label mb-0 fw-bold">Seleziona Anno:</label>
                    <select name="annoSelezionato" id="annoSelezionato" class="form-select w-auto" onchange="this.form.submit()">
                        @{
                            var anniFiscali = ViewBag.AnniFiscali as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>;
                        }
                        @if (anniFiscali != null)
                        {
                            @foreach (var anno in anniFiscali)
                            {
                                @if (anno.Selected)
                                {
                                    <option value="@anno.Value" selected>@anno.Text</option>
                                }
                                else
                                {
                                    <option value="@anno.Value">@anno.Text</option>
                                }
                            }
                        }
                    </select>
                    <div class="ms-auto d-flex gap-2">
                        <a href="@Url.Action("Index", "GestioneAttivita")" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Gestione Attività
                        </a>
                        <a href="@Url.Action("Index", "Clienti")" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-users me-1"></i>Gestione Clienti
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scadenza del 760 -->
@if (annoFiscale?.Scadenza760.HasValue == true)
{
    var scadenza = annoFiscale.Scadenza760.Value;
    var giorniRimanenti = (scadenza - DateTime.Today).Days;
    var alertClass = giorniRimanenti <= 30 ? "danger" : (giorniRimanenti <= 60 ? "warning" : "info");
    
    <div class="alert alert-@alertClass mb-4">
        <i class="fas fa-calendar-alt me-2"></i>
        <strong>Scadenza Mod. 760:</strong> @scadenza.ToString("dd/MM/yyyy")
        @if (giorniRimanenti > 0)
        {
            <span class="ms-2">(@giorniRimanenti giorni rimanenti)</span>
        }
        else if (giorniRimanenti == 0)
        {
            <span class="ms-2 fw-bold">(SCADE OGGI!)</span>
        }
        else
        {
            <span class="ms-2 fw-bold">(SCADUTO da @(-giorniRimanenti) giorni)</span>
        }
    </div>
}

<!-- Tabella Attività - Modifica Inline -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Elenco Attività 760 - @(annoFiscale?.AnnoDescrizione ?? $"Anno {annoSelezionato}")
        </h5>
    </div>
    <div class="card-body p-0">
        @if (Model.Any())
        {
            <form id="bulkUpdateForm" method="post" action="@Url.Action("BulkUpdate")">
                @Html.AntiForgeryToken()
                <input type="hidden" name="annoSelezionato" value="@annoSelezionato" />
                
                <!-- Filtri e Pulsanti -->
                <div class="mb-3">
                    <!-- Prima riga filtri -->
                    <div class="d-flex flex-wrap gap-3 align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <label for="filtroNomeCliente" class="form-label mb-0 fw-bold">Cliente:</label>
                            <input type="text" id="filtroNomeCliente" class="form-control form-control-sm" style="width: 180px;" placeholder="Cerca per nome...">
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <label for="filtroProfessionista" class="form-label mb-0 fw-bold">Professionista:</label>
                            <select id="filtroProfessionista" class="form-select form-select-sm" style="width: auto;">
                                <option value="">Tutti</option>
                                @{
                                    var professionistiFiltro = ViewBag.Professionisti as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>;
                                }
                                @if (professionistiFiltro != null)
                                {
                                    @foreach (var prof in professionistiFiltro)
                                    {
                                        <option value="@prof.Value">@prof.Text</option>
                                    }
                                }
                            </select>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <label for="filtroRaccoltaDocumenti" class="form-label mb-0 fw-bold">Raccolta Doc.:</label>
                            <select id="filtroRaccoltaDocumenti" class="form-select form-select-sm" style="width: auto;">
                                <option value="">Tutti</option>
                                <option value="da_richiedere">Da Richiedere</option>
                                <option value="richiesti">Richiesti</option>
                                <option value="ricevuti">Ricevuti</option>
                            </select>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <label for="filtroDrStatus" class="form-label mb-0 fw-bold">Stato DR:</label>
                            <select id="filtroDrStatus" class="form-select form-select-sm" style="width: auto;">
                                <option value="">Tutti</option>
                                <option value="inserita">Solo DR Inserita</option>
                                <option value="controllata">Solo DR Controllata</option>
                                <option value="spedita">Solo DR Spedita</option>
                                <option value="complete">Tutte Complete</option>
                                <option value="incomplete">Incomplete</option>
                            </select>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <label for="filtroIsaStatus" class="form-label mb-0 fw-bold">ISA:</label>
                            <select id="filtroIsaStatus" class="form-select form-select-sm" style="width: auto;">
                                <option value="">Tutti</option>
                                <option value="file_disponibile">File ISA Disponibile</option>
                                <option value="dr_inseriti">ISA DR Inseriti</option>
                                <option value="all_isa_complete">ISA Completi</option>
                                <option value="missing">ISA Mancanti</option>
                            </select>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <label for="filtroBilancio" class="form-label mb-0 fw-bold">Bilancio:</label>
                            <select id="filtroBilancio" class="form-select form-select-sm" style="width: auto;">
                                <option value="">Tutti</option>
                                <option value="da_chiudere">Da Chiudere</option>
                                <option value="chiuso">Chiuso</option>
                            </select>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <label for="filtroPecFirmata" class="form-label mb-0 fw-bold">PEC/Firmata:</label>
                            <select id="filtroPecFirmata" class="form-select form-select-sm" style="width: auto;">
                                <option value="">Tutti</option>
                                <option value="pec_inviata">PEC Inviata</option>
                                <option value="dr_firmata">DR Firmata</option>
                                <option value="both_complete">PEC + Firmata</option>
                                <option value="incomplete">Incompleti</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Seconda riga con pulsanti di azione -->
                    <div class="d-flex flex-wrap justify-content-between align-items-center mt-2 gap-2">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterTable()">
                                <i class="fas fa-filter me-1"></i>Applica Filtri
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFilters()">
                                <i class="fas fa-times me-1"></i>Reset
                            </button>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-save me-1"></i>Salva Tutto
                            </button>
                            <a href="@Url.Action("ExportExcel", new { anno = annoSelezionato })" class="btn btn-warning btn-sm">
                                <i class="fas fa-file-excel me-1"></i>Export Excel
                            </a>
                            <button type="button" class="btn btn-danger btn-sm" onclick="confermaEliminazioneAnno()">
                                <i class="fas fa-trash-alt me-1"></i>Elimina tutti gli inserimenti dell'anno
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tabella con intestazioni fisse -->
                <div class="table-container" style="max-height: 70vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 180px;">Cliente</th>
                                <th style="width: 140px;">Professionista</th>
                                <th style="width: 140px;">Appuntamento</th>
                                <th style="width: 120px;">Codice DR</th>
                                <th style="width: 140px;">Raccolta Doc.</th>
                                <th style="width: 120px;" class="text-center">Bilancio Stato</th>
                                <th style="width: 130px;" class="text-center">Bilancio Inserim.</th>
                                <th style="width: 130px;" class="text-center">Bilancio Deposito</th>
                                <th style="width: 200px;" class="text-center">Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{int index = 0;}
                            @foreach (var item in Model)
                            {
                                <!-- PRIMA RIGA: Dati Principali -->
                                <tr>
                                    <input type="hidden" name="[@index].IdAttivita760" value="@item.IdAttivita760" />
                                    <input type="hidden" name="[@index].IdAnno" value="@item.IdAnno" />
                                    <input type="hidden" name="[@index].IdCliente" value="@item.IdCliente" />
                                    <input type="hidden" name="[@index].CreatedAt" value="@item.CreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")" />
                                    
                                    <!-- Cliente -->
                                    <td class="align-middle" style="width: 180px;">
                                        <div>
                                            <strong>@item.Cliente?.NomeCliente</strong><br/>
                                            <small class="text-muted">@item.Cliente?.CodiceAteco</small>
                                        </div>
                                    </td>
                                    
                                    <!-- Professionista -->
                                    <td class="align-middle" style="width: 140px;">
                                        <select name="[@index].IdProfessionista" class="form-select form-select-sm">
                                            <option value="">-- Nessuno --</option>
                                            @{
                                                var professionisti = ViewBag.Professionisti as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>;
                                            }
                                            @if (professionisti != null)
                                            {
                                                @foreach (var prof in professionisti)
                                                {
                                                    @if (prof.Value == item.IdProfessionista?.ToString())
                                                    {
                                                        <option value="@prof.Value" selected>@prof.Text</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@prof.Value">@prof.Text</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </td>
                                    
                                    <!-- Appuntamento Data/Ora -->
                                    <td class="align-middle" style="width: 140px;">
                                        <input type="datetime-local" name="[@index].AppuntamentoDataOra" 
                                               value="@(item.AppuntamentoDataOra?.ToString("yyyy-MM-ddTHH:mm"))" 
                                               class="form-control form-control-sm" />
                                    </td>
                                    
                                    <!-- Codice DR -->
                                    <td class="align-middle" style="width: 120px;">
                                        <input type="text" name="[@index].CodiceDr" value="@item.CodiceDr" 
                                               class="form-control form-control-sm" placeholder="Codice DR" />
                                    </td>
                                    
                                    <!-- Raccolta Documenti -->
                                    <td class="align-middle" style="width: 140px;">
                                        <select name="[@index].RaccoltaDocumenti" class="form-select form-select-sm">
                                            @if (item.RaccoltaDocumenti == "da_richiedere")
                                            {
                                                <option value="da_richiedere" selected>Da Richiedere</option>
                                            }
                                            else
                                            {
                                                <option value="da_richiedere">Da Richiedere</option>
                                            }
                                            @if (item.RaccoltaDocumenti == "richiesti")
                                            {
                                                <option value="richiesti" selected>Richiesti</option>
                                            }
                                            else
                                            {
                                                <option value="richiesti">Richiesti</option>
                                            }
                                            @if (item.RaccoltaDocumenti == "ricevuti")
                                            {
                                                <option value="ricevuti" selected>Ricevuti</option>
                                            }
                                            else
                                            {
                                                <option value="ricevuti">Ricevuti</option>
                                            }
                                        </select>
                                    </td>
                                    
                                    <!-- Bilancio Stato -->
                                    <td class="align-middle" style="width: 120px;">
                                        <select name="[@index].BilancioStato" 
                                                class="form-select form-select-sm @(item.BilancioStato == "chiuso" ? "bg-success text-white" : "bg-danger text-white")">
                                            @if (item.BilancioStato == "da_chiudere")
                                            {
                                                <option value="da_chiudere" selected>Da Chiudere</option>
                                            }
                                            else
                                            {
                                                <option value="da_chiudere">Da Chiudere</option>
                                            }
                                            @if (item.BilancioStato == "chiuso")
                                            {
                                                <option value="chiuso" selected>Chiuso</option>
                                            }
                                            else
                                            {
                                                <option value="chiuso">Chiuso</option>
                                            }
                                        </select>
                                    </td>
                                    
                                    <!-- Bilancio Inserimento -->
                                    <td class="align-middle" style="width: 130px;">
                                        <select name="[@index].BilancioInserimento" 
                                                class="form-select form-select-sm @(item.BilancioInserimento == "inserito" ? "bg-success text-white" : "bg-danger text-white")">
                                            @if (item.BilancioInserimento == "da_inserire")
                                            {
                                                <option value="da_inserire" selected>Da Inserire</option>
                                            }
                                            else
                                            {
                                                <option value="da_inserire">Da Inserire</option>
                                            }
                                            @if (item.BilancioInserimento == "inserito")
                                            {
                                                <option value="inserito" selected>Inserito</option>
                                            }
                                            else
                                            {
                                                <option value="inserito">Inserito</option>
                                            }
                                        </select>
                                    </td>
                                    
                                    <!-- Bilancio Deposito -->
                                    <td class="align-middle" style="width: 130px;">
                                        <select name="[@index].BilancioDeposito" 
                                                class="form-select form-select-sm @(item.BilancioDeposito == "depositato" ? "bg-success text-white" : "bg-danger text-white")">
                                            @if (item.BilancioDeposito == "da_depositare")
                                            {
                                                <option value="da_depositare" selected>Da Depositare</option>
                                            }
                                            else
                                            {
                                                <option value="da_depositare">Da Depositare</option>
                                            }
                                            @if (item.BilancioDeposito == "depositato")
                                            {
                                                <option value="depositato" selected>Depositato</option>
                                            }
                                            else
                                            {
                                                <option value="depositato">Depositato</option>
                                            }
                                        </select>
                                    </td>
                                    
                                    <!-- Note -->
                                    <td class="align-middle" style="width: 200px;">
                                        <textarea name="[@index].Note" class="form-control form-control-sm" rows="2" placeholder="Note...">@item.Note</textarea>
                                    </td>
                                </tr>
                                
                                <!-- SECONDA RIGA: Controlli Checkbox e Stati -->
                                <tr class="table-light">
                                    <td colspan="9">
                                        <div class="row g-2 p-2">
                                            <!-- Colonna 1: DR Stati -->
                                            <div class="col-md-3">
                                                <div class="row g-1">
                                                    <div class="col-4 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">DR Inserita</label>
                                                        @if (item.DrInserita)
                                                        {
                                                            <input type="checkbox" name="[@index].DrInserita" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].DrInserita" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].DrInserita" value="false" />
                                                        <input type="date" name="[@index].DrInseritaData" value="@(item.DrInseritaData?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm mt-1 text-center" style="font-size: 0.7rem;" />
                                                    </div>
                                                    <div class="col-4 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">DR Controllata</label>
                                                        @if (item.DrControllata)
                                                        {
                                                            <input type="checkbox" name="[@index].DrControllata" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].DrControllata" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].DrControllata" value="false" />
                                                        <input type="date" name="[@index].DrControllataData" value="@(item.DrControllataData?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm mt-1 text-center" style="font-size: 0.7rem;" />
                                                    </div>
                                                    <div class="col-4 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">DR Spedita</label>
                                                        @if (item.DrSpedita)
                                                        {
                                                            <input type="checkbox" name="[@index].DrSpedita" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].DrSpedita" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].DrSpedita" value="false" />
                                                        <input type="date" name="[@index].DrSpeditaData" value="@(item.DrSpeditaData?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm mt-1 text-center" style="font-size: 0.7rem;" />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Colonna 2: ISA Stati -->
                                            <div class="col-md-2">
                                                <div class="row g-1">
                                                    <div class="col-6 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">File ISA</label>
                                                        @if (item.FileIsa)
                                                        {
                                                            <input type="checkbox" name="[@index].FileIsa" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].FileIsa" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].FileIsa" value="false" />
                                                    </div>
                                                    <div class="col-6 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">ISA DR Inseriti</label>
                                                        @if (item.IsaDrInseriti)
                                                        {
                                                            <input type="checkbox" name="[@index].IsaDrInseriti" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].IsaDrInseriti" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].IsaDrInseriti" value="false" />
                                                        <input type="date" name="[@index].IsaDrInseritiData" value="@(item.IsaDrInseritiData?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm mt-1 text-center" style="font-size: 0.7rem;" />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Colonna 3: Altri Controlli -->
                                            <div class="col-md-3">
                                                <div class="row g-1">
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-danger fw-bold d-block" style="font-size: 0.8rem;">PEC</label>
                                                        @if (item.PecInvioDr)
                                                        {
                                                            <input type="checkbox" name="[@index].PecInvioDr" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].PecInvioDr" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].PecInvioDr" value="false" />
                                                    </div>
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-primary fw-bold d-block" style="font-size: 0.8rem;">Firmata</label>
                                                        @if (item.DrFirmata)
                                                        {
                                                            <input type="checkbox" name="[@index].DrFirmata" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].DrFirmata" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].DrFirmata" value="false" />
                                                    </div>
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">Ricevuta</label>
                                                        @if (item.Ricevuta)
                                                        {
                                                            <input type="checkbox" name="[@index].Ricevuta" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].Ricevuta" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].Ricevuta" value="false" />
                                                    </div>
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">CCIAA</label>
                                                        @if (item.Cciaa)
                                                        {
                                                            <input type="checkbox" name="[@index].Cciaa" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].Cciaa" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].Cciaa" value="false" />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Colonna 4: F24 -->
                                            <div class="col-md-4">
                                                <div class="row g-1">
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">N. Rate 1°</label>
                                                        <input type="number" name="[@index].NumeroRateF24PrimoAccontoSaldo" value="@item.NumeroRateF24PrimoAccontoSaldo" 
                                                               class="form-control form-control-sm text-center" min="0" max="99" />
                                                    </div>
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">1° Consegnato</label>
                                                        @if (item.F24PrimoAccontoSaldoConsegnato)
                                                        {
                                                            <input type="checkbox" name="[@index].F24PrimoAccontoSaldoConsegnato" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].F24PrimoAccontoSaldoConsegnato" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].F24PrimoAccontoSaldoConsegnato" value="false" />
                                                    </div>
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">2° Acconto</label>
                                                        <input type="number" name="[@index].F24SecondoAcconto" value="@item.F24SecondoAcconto" 
                                                               class="form-control form-control-sm text-center" min="0" max="99" />
                                                    </div>
                                                    <div class="col-3 text-center">
                                                        <label class="form-label text-dark fw-bold d-block" style="font-size: 0.8rem;">2° Consegnato</label>
                                                        @if (item.F24SecondoAccontoConsegnato)
                                                        {
                                                            <input type="checkbox" name="[@index].F24SecondoAccontoConsegnato" value="true" checked class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" name="[@index].F24SecondoAccontoConsegnato" value="true" class="form-check-input d-block mx-auto" style="accent-color: black; border: 2px solid black;" />
                                                        }
                                                        <input type="hidden" name="[@index].F24SecondoAccontoConsegnato" value="false" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                index++;
                            }
                        </tbody>
                    </table>
                </div>
            </form>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nessuna attività 760 trovata</h5>
                <p class="text-muted">
                    @if (annoFiscale != null)
                    {
                        <span>Non ci sono clienti con Mod. 760 attivo per l'anno @annoFiscale.Anno, oppure le attività non sono ancora state create.</span>
                    }
                    else
                    {
                        <span>Anno fiscale non configurato o non trovato.</span>
                    }
                </p>
            </div>
        }
    </div>
</div>

 <script>
 $(document).ready(function() {
     $('[title]').tooltip();
     
     // Inizializza contatore
     updateRowCount();
     
     // Filtro ricerca in tempo reale per nome cliente
     $('#filtroNomeCliente').on('input', function() {
         filterTable();
     });
     
     // Event listeners per i filtri dropdown
     $('#filtroProfessionista, #filtroRaccoltaDocumenti, #filtroDrStatus, #filtroIsaStatus, #filtroBilancio, #filtroPecFirmata').change(function() {
         filterTable();
     });
 });

 function filterTable() {
     const filtroCliente = $('#filtroNomeCliente').val().toLowerCase();
     const filtroProfessionista = $('#filtroProfessionista').val();
     const filtroRaccolta = $('#filtroRaccoltaDocumenti').val();
     const filtroDrStatus = $('#filtroDrStatus').val();
     const filtroIsa = $('#filtroIsaStatus').val();
     const filtroBilancio = $('#filtroBilancio').val();
     const filtroPecFirmata = $('#filtroPecFirmata').val();
 
     $('tbody tr').each(function(index) {
         if (index % 2 === 0) { // Solo righe pari (prima riga di ogni cliente)
             const $firstRow = $(this);
             const $secondRow = $firstRow.next();
             let showRow = true;
 
             // Filtro Cliente
             if (filtroCliente && showRow) {
                 const nomeCliente = $firstRow.find('strong').first().text().toLowerCase();
                 if (!nomeCliente.includes(filtroCliente)) showRow = false;
             }
 
             // Filtro Professionista
             if (filtroProfessionista && showRow) {
                 const professionistaValue = $firstRow.find('select[name*=".IdProfessionista"]').val();
                 if (professionistaValue !== filtroProfessionista) showRow = false;
             }
 
             // Filtro Raccolta Documenti
             if (filtroRaccolta && showRow) {
                 const raccoltaValue = $firstRow.find('select[name*=".RaccoltaDocumenti"]').val();
                 if (raccoltaValue !== filtroRaccolta) showRow = false;
             }
 
             // Filtro Bilancio Stato
             if (filtroBilancio && showRow) {
                 const bilancioStato = $firstRow.find('select[name*=".BilancioStato"]').val();
                 if (bilancioStato !== filtroBilancio) showRow = false;
             }
 
             // Filtro DR Status (controlli nella seconda riga)
             if (filtroDrStatus && showRow) {
                 const drInserita = $secondRow.find('input[name*=".DrInserita"][value="true"]').is(':checked');
                 const drControllata = $secondRow.find('input[name*=".DrControllata"][value="true"]').is(':checked');
                 const drSpedita = $secondRow.find('input[name*=".DrSpedita"][value="true"]').is(':checked');
                 
                 switch(filtroDrStatus) {
                     case 'inserita':
                         if (!drInserita) showRow = false;
                         break;
                     case 'controllata':
                         if (!drControllata) showRow = false;
                         break;
                     case 'spedita':
                         if (!drSpedita) showRow = false;
                         break;
                     case 'complete':
                         if (!(drInserita && drControllata && drSpedita)) showRow = false;
                         break;
                     case 'incomplete':
                         if (drInserita && drControllata && drSpedita) showRow = false;
                         break;
                 }
             }
 
             // Filtro ISA (controlli nella seconda riga)
             if (filtroIsa && showRow) {
                 const fileIsa = $secondRow.find('input[name*=".FileIsa"][value="true"]').is(':checked');
                 const isaDrInseriti = $secondRow.find('input[name*=".IsaDrInseriti"][value="true"]').is(':checked');
                 
                 switch(filtroIsa) {
                     case 'file_disponibile':
                         if (!fileIsa) showRow = false;
                         break;
                     case 'dr_inseriti':
                         if (!isaDrInseriti) showRow = false;
                         break;
                     case 'all_isa_complete':
                         if (!fileIsa || !isaDrInseriti) showRow = false;
                         break;
                     case 'missing':
                         if (fileIsa || isaDrInseriti) showRow = false;
                         break;
                 }
             }
 
             // Filtro PEC/Firmata (controlli nella seconda riga)
             if (filtroPecFirmata && showRow) {
                 const pecInvioDr = $secondRow.find('input[name*=".PecInvioDr"][value="true"]').is(':checked');
                 const drFirmata = $secondRow.find('input[name*=".DrFirmata"][value="true"]').is(':checked');
                 
                 switch(filtroPecFirmata) {
                     case 'pec_inviata':
                         if (!pecInvioDr) showRow = false;
                         break;
                     case 'dr_firmata':
                         if (!drFirmata) showRow = false;
                         break;
                     case 'both_complete':
                         if (!pecInvioDr || !drFirmata) showRow = false;
                         break;
                     case 'incomplete':
                         if (pecInvioDr && drFirmata) showRow = false;
                         break;
                 }
             }
 
             // Mostra/nascondi entrambe le righe
             if (showRow) {
                 $firstRow.show();
                 $secondRow.show();
             } else {
                 $firstRow.hide();
                 $secondRow.hide();
             }
         }
     });
     
     // Aggiorna contatore
     updateRowCount();
 }

 function updateRowCount() {
     const totalClients = Math.floor($('tbody tr').length / 2); // Dividi per 2 perché ogni cliente ha 2 righe
     let visibleClients = 0;
     
     $('tbody tr').each(function(index) {
         if (index % 2 === 0 && $(this).is(':visible')) { // Solo righe pari visibili
             visibleClients++;
         }
     });
     
     // Crea o aggiorna il contatore se non esiste
     if ($('#rowCounter').length === 0) {
         $('.card-header h5').append(' <span id="rowCounter" class="badge bg-light text-dark ms-2"></span>');
     }
     
     $('#rowCounter').text(`${visibleClients} di ${totalClients} clienti`);
 }

 function resetFilters() {
     $('#filtroNomeCliente').val('');
     $('#filtroProfessionista').val('');
     $('#filtroRaccoltaDocumenti').val('');
     $('#filtroDrStatus').val('');
     $('#filtroIsaStatus').val('');
     $('#filtroBilancio').val('');
     $('#filtroPecFirmata').val('');
     $('tbody tr').show();
     updateRowCount();
 }

 function confermaEliminazioneAnno() {
     const anno = @annoSelezionato;
     const totalClients = Math.floor($('tbody tr').length / 2);
     
     if (!confirm(`⚠️ ATTENZIONE!\n\nStai per eliminare TUTTI i ${totalClients} inserimenti del modello 760 dell'anno ${anno}.\n\nQuesta operazione è IRREVERSIBILE!\n\nVuoi continuare?`)) {
         return;
     }
     
     const confermaParola = prompt(`🚨 ULTIMA CONFERMA!\n\nPer eliminare DEFINITIVAMENTE tutti i ${totalClients} inserimenti Mod. 760 dell'anno ${anno},\n\nScrivi esattamente: ELIMINA\n\ne poi premi OK:`);
     
     if (confermaParola !== "ELIMINA") {
         alert("❌ Operazione annullata!\n\nDevi scrivere esattamente 'ELIMINA' per confermare.");
         return;
     }
     
     window.location.href = '@Url.Action("EliminaTuttiPerAnno", new { anno = annoSelezionato })';
 }
</script>
