@{
    ViewData["Title"] = "Migrazione Attività Esistenti";
    var clientiDaMigrare = ViewBag.ClientiDaMigrare as IEnumerable<dynamic>;
    var annoCorrente = ViewBag.AnnoCorrente;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Migrazione Attività Esistenti - Anno @annoCorrente
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle me-2"></i>Situazione Rilevata</h5>
                        <p>Sono stati trovati clienti che sono stati cambiati da <strong>Mod.730</strong> a <strong>Mod.740</strong>, ma hanno ancora dati nelle tabelle delle attività 730.</p>
                        <p>Questa utility ti permette di <strong>migrare automaticamente</strong> tutti i dati dalle attività 730 alle corrispondenti attività 740.</p>
                    </div>

                    @if (clientiDaMigrare != null && clientiDaMigrare.Any())
                    {
                        <div class="alert alert-warning">
                            <h5><i class="fas fa-users me-2"></i>Clienti da Migrare (@clientiDaMigrare.Count())</h5>
                            <p>I seguenti clienti hanno attività 730 da migrare a 740:</p>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Codice DR</th>
                                        <th>Raccolta Documenti</th>
                                        <th>ID Attività 730</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var cliente in clientiDaMigrare)
                                    {
                                        <tr>
                                            <td><strong>@cliente.ClienteNome</strong></td>
                                            <td>@(cliente.CodiceDr ?? "N/A")</td>
                                            <td>
                                                <span class="badge @(cliente.RaccoltaDocumenti == "completa" ? "bg-success" : cliente.RaccoltaDocumenti == "parziale" ? "bg-warning" : "bg-secondary")">
                                                    @cliente.RaccoltaDocumenti
                                                </span>
                                            </td>
                                            <td><small class="text-muted">#@cliente.AttivitaId</small></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-danger mt-3">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>ATTENZIONE</h5>
                            <ul class="mb-0">
                                <li>Questa operazione <strong>sposterà definitivamente</strong> tutti i dati dalle attività 730 alle attività 740</li>
                                <li>I dati nelle tabelle 730 verranno <strong>cancellati</strong> dopo la migrazione</li>
                                <li>I nuovi record 740 avranno i campi specifici (ISA, Bilancio, etc.) impostati sui valori di default</li>
                                <li>L'operazione è <strong>irreversibile</strong></li>
                            </ul>
                        </div>

                        <div class="d-flex gap-3 mt-4">
                            <form asp-action="ExecuteMigration" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-danger btn-lg" 
                                        onclick="return confirm('Sei sicuro di voler procedere con la migrazione?\n\nQuesta operazione sposterà definitivamente tutti i dati da Mod.730 a Mod.740 e non può essere annullata.')">
                                    <i class="fas fa-exchange-alt me-2"></i>
                                    Esegui Migrazione (@clientiDaMigrare.Count() Clienti)
                                </button>
                            </form>
                            
                            <a asp-action="Index" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>
                                Annulla
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>Nessuna Migrazione Necessaria</h5>
                            <p class="mb-0">Non sono stati trovati clienti che necessitano di migrazione da Mod.730 a Mod.740 per l'anno @annoCorrente.</p>
                        </div>

                        <a asp-action="Index" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Torna alla Lista Clienti
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table th {
    white-space: nowrap;
}
.alert {
    border-left: 4px solid;
}
.alert-info {
    border-left-color: #17a2b8;
}
.alert-warning {
    border-left-color: #ffc107;
}
.alert-danger {
    border-left-color: #dc3545;
}
.alert-success {
    border-left-color: #28a745;
}
</style>



